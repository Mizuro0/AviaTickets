<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Airports</title>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <!-- Add CSRF token meta tags -->
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>
<body>

<div class="container mt-4">
    <h2>Search Airports</h2>
    <div class="form-group">
        <label for="departureInput">Departure Airport:</label>
        <input type="text" class="form-control" id="departureInput" placeholder="Enter departure city or airport name">
        <input type="hidden" id="departureCode" name="departureCode">
    </div>
    <div class="form-group">
        <label for="arrivalInput">Arrival Airport:</label>
        <input type="text" class="form-control" id="arrivalInput" placeholder="Enter arrival city or airport name">
        <input type="hidden" id="arrivalCode" name="arrivalCode">
    </div>
    <div class="form-group">
        <label for="tripClass">Trip Class:</label>
        <select class="form-control" id="tripClass">
            <option value="0">Economy</option>
            <option value="1">Business</option>
            <option value="2">First Class</option>
        </select>
    </div>
    <div class="form-group">
        <label for="departDate">Departure Date:</label>
        <input type="date" class="form-control" id="departDate">
    </div>
    <div class="form-group">
        <label for="returnDate">Return Date:</label>
        <input type="date" class="form-control" id="returnDate">
    </div>
    <button id="searchButton" class="btn btn-primary">Search Flights</button>
    <div id="searchResults"></div> <!-- Container to display search results -->
</div>

<script>
    // Функция для отправки POST запроса
    function sendPostRequest(requestData) {
        $.ajax({
            url: '/races/addFoundedRaces',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(requestData),
            beforeSend: function(xhr) {
                // Получаем CSRF токен из мета тегов и добавляем его в заголовок запроса
                var token = $("meta[name='_csrf']").attr("content");
                var header = $("meta[name='_csrf_header']").attr("content");
                xhr.setRequestHeader(header, token);
            },
            success: function(response) {
                console.log('Search results:', response);
                // Очистить содержимое страницы перед обновлением
                window.location.replace("/main/races.html"); // Путь к файлу races.html внутри папки resources/templates/main

                // $('#searchResults').html('<div class="alert alert-success">Search results: ' + JSON.stringify(response) + '</div>');});
            },

            error: function(xhr, status, error) {
                console.error('Error:', error);
                $('#searchResults').html('<div class="alert alert-danger">An error occurred while searching flights.</div>');
            }
        });
    }

    $(document).ready(function() {
        $("#departureInput, #arrivalInput").autocomplete({
            source: function(request, response) {
                $.ajax({
                    url: "/api/airports",
                    dataType: "json",
                    data: {
                        searchTerm: request.term
                    },
                    success: function(data) {
                        response(data.map(function(item) {
                            return {
                                label: item.name + " (" + item.city + ", " + item.country + ")",
                                value: item.name,
                                id: item.iataCode
                            };
                        }));
                    }
                });
            },
            minLength: 2,
            select: function(event, ui) {
                $(this).siblings("input[type=hidden]").val(ui.item.id);
            }
        });

        $('#searchButton').click(function() {
            let departureIata = $('#departureCode').val();
            let arrivalIata = $('#arrivalCode').val();
            let tripClass = $('#tripClass').val();
            let departDate = $('#departDate').val();
            let returnDate = $('#returnDate').val();

            if (departureIata && arrivalIata && tripClass && departDate && returnDate) {
                let searchData = {
                    originIata: departureIata,
                    destinationIata: arrivalIata,
                    tripClass: tripClass,
                    departDate: departDate,
                    returnDate: returnDate
                };

                sendPostRequest(searchData);
            } else {
                $('#searchResults').html('<div class="alert alert-warning">Please fill in all fields.</div>');
            }
        });
    });
</script>

</body>
</html>

